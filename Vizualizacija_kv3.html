<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Video Game Sales by Genre</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <link rel="stylesheet" type="text/css" href="style.css">

</head>

<body>
  <h1>VIZUALIZACIJA PRODAJE VIDEOIGARA</h1>
  <div class="header">
    <div class="slider_">
      <label for="yearSlider">Select Year:</label>
      <input type="range" id="yearSlider" min="1980" max="2016" step="1" value="2016">
      <span id="yearValue">2016</span>
    </div>
    <div class="genre_">
      <label for="genreSelect">Select Genre:</label>
      <select id="genreSelect">
        <option value="all">All</option>
      </select>
    </div>
  </div>

  <div class="chart-container">
    <svg id="chart1" class="chart" width="700" height="500"></svg>
    <svg id="chart2" class="chart" width="700" height="500"></svg>
  </div>

  <script>
    var margin = { top: 40, right: 20, bottom: 70, left: 80 };
    var width = 700 - margin.left - margin.right;
    var height = 500 - margin.top - margin.bottom;

    var colorPalette = [
      "#1f77b4", // blue
      "#ff7f0e", // orange
      "#2ca02c", // green
      "#d62728", // red
      "#9467bd", // purple
      "#8c564b", // brown
      "#e377c2", // pink
      "#7f7f7f", // gray
      "#bcbd22", // olive
      "#17becf", // cyan
      "#ff9896", // salmon
      "#aec7e8"  // light blue
    ];

    // Create SVG elements
    var svg1 = d3.select("#chart1")
      .attr("width", width + margin.left + margin.right)
      .attr("height", height + margin.top + margin.bottom)
      .append("g")
      .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    var svg2 = d3.select("#chart2")
      .attr("width", width + margin.left + margin.right)
      .attr("height", height + margin.top + margin.bottom)
      .append("g")
      .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    // Create scales
    var x1 = d3.scaleBand()
      .range([0, width])
      .padding(0.1);

    var y1 = d3.scaleLinear()
      .range([height, 0]);

    var x2 = d3.scaleLinear()
      .domain([1980, 2016])
      .range([0, width]);

    var y2 = d3.scaleLinear()
      .range([height, 0]);

    // Add initial axes groups
    svg1.append("g")
      .attr("class", "axis-x1")
      .attr("transform", "translate(0," + height + ")");

    svg1.append("g")
      .attr("class", "axis-y1");

    svg2.append("g")
      .attr("class", "axis-x2")
      .attr("transform", "translate(0," + height + ")");

    svg2.append("g")
      .attr("class", "axis-y2");

    // Load JSON data
    d3.json("csvjson.json").then(function (data) {
      // Get unique years and genres from data
      var years = Array.from(new Set(data.map(function (d) { return d.Year; }))).sort();
      var genres = Array.from(new Set(data.map(function (d) { return d.Genre; }))).sort();

      // Update slider range based on years in data
      var yearSlider = d3.select("#yearSlider");
      yearSlider.attr("min", d3.min(years))
        .attr("max", d3.max(years))
        .attr("value", d3.max(years));

      // Add genre options to select dropdown
      var genreSelect = d3.select("#genreSelect");
      genreSelect.selectAll("option.genre-option")
        .data(genres)
        .enter()
        .append("option")
        .attr("class", "genre-option")
        .attr("value", function (d) { return d; })
        .text(function (d) { return d; });

      // Function to update the first chart based on the selected year
      function updateChart1(selectedYear) {
        d3.select("#yearValue").text(selectedYear);

        // Filter data based on the selected year
        var filteredData = selectedYear === 'all' ? data : data.filter(function (d) {
          return d.Year == selectedYear;
        });

        var genreCounts = {};
        filteredData.forEach(function (game) {
          if (game.Genre in genreCounts) {
            genreCounts[game.Genre]++;
          } else {
            genreCounts[game.Genre] = 1;
          }
        });

        // Convert genre counts to array of objects
        var genreData = [];
        for (var genre in genreCounts) {
          genreData.push({
            genre: genre,
            count: genreCounts[genre]
          });
        }

        genreData.sort(function (a, b) {
          return b.count - a.count;
        });

        // Update scales
        x1.domain(genreData.map(function (d) { return d.genre; }));
        y1.domain([0, d3.max(genreData, function (d) { return d.count; })]).nice();

        // Bind data to bars
        var bars = svg1.selectAll(".bar1")
          .data(genreData);

        // Enter new bars
        bars.enter().append("rect")
          .attr("class", "bar1")
          .attr("x", function (d) { return x1(d.genre); })
          .attr("y", function (d) { return y1(d.count); })
          .attr("width", x1.bandwidth())
          .attr("height", function (d) { return height - y1(d.count); })
          .attr("fill", function (d, i) { return colorPalette[i % colorPalette.length]; });

        // Update existing bars
        bars.transition()
          .duration(750)
          .attr("x", function (d) { return x1(d.genre); })
          .attr("y", function (d) { return y1(d.count); })
          .attr("width", x1.bandwidth())
          .attr("height", function (d) { return height - y1(d.count); })
          .attr("fill", function (d, i) { return colorPalette[i % colorPalette.length]; });

        // Remove old bars
        bars.exit().remove();

        // Update x axis
        svg1.select(".axis-x1")
          .transition()
          .duration(750)
          .call(d3.axisBottom(x1))
          .selectAll("text")
          .style("text-anchor", "end")
          .attr("dx", "-.8em")
          .attr("dy", ".15em")
          .attr("transform", "rotate(-45)");

        // Update y axis
        svg1.select(".axis-y1")
          .transition()
          .duration(750)
          .call(d3.axisLeft(y1)
          );

        // Add x axis label
        svg1.selectAll(".x-axis-label1").remove();
        svg1.append("text")
          .attr("class", "x-axis-label1")
          .attr("x", width / 2)
          .attr("y", height + margin.bottom - 10)
          .style("text-anchor", "middle")
          .text("Genre");

        // Add y axis label
        svg1.selectAll(".y-axis-label1").remove();
        svg1.append("text")
          .attr("class", "y-axis-label1")
          .attr("transform", "rotate(-90)")
          .attr("y", 0 - margin.left)
          .attr("x", 0 - (height / 2))
          .attr("dy", "1em")
          .style("text-anchor", "middle")
          .text("Number of Games");

        // Add title
        svg1.selectAll(".chart-title1").remove();
        svg1.append("text")
          .attr("class", "chart-title1")
          .attr("x", width / 2)
          .attr("y", 0 - (margin.top / 2))
          .attr("text-anchor", "middle")
          .style("font-size", "16px")
          .style("text-decoration", "underline")
          .text("Number of Games by Genre for " + selectedYear);
      }

      // Function to update the second chart based on the selected genre
      function updateChart2(selectedGenre) {
        // Filter data based on the selected genre
        var filteredData = selectedGenre === 'all' ? data : data.filter(function (d) {
          return d.Genre == selectedGenre;
        });

        var yearCounts = {};
        for (var year = 1980; year <= 2016; year++) {
          yearCounts[year] = 0;
        }
        filteredData.forEach(function (game) {
          if (game.Year in yearCounts) {
            yearCounts[game.Year]++;
          } else {
            yearCounts[game.Year] = 1;
          }
        });

        // Convert year counts to array of objects
        var yearData = [];
        for (var year in yearCounts) {
          yearData.push({
            year: year,
            count: yearCounts[year]
          });
        }

        yearData.sort(function (a, b) {
          return a.year - b.year;
        });

        // Update scales
        x2.domain(d3.extent(yearData, function (d) { return d.year; }));
        y2.domain([0, d3.max(yearData, function (d) { return d.count; })]).nice();

        // Bind data to bars
        var bars = svg2.selectAll(".bar2")
          .data(yearData);

        var barWidth = width / (2016 - 1980 + 1);
        // Enter new bars
        bars.enter().append("rect")
          .attr("class", "bar2")
          .attr("x", function (d) { return x2(d.year) - barWidth / 2; })
          .attr("y", function (d) { return y2(d.count); })
          .attr("width", barWidth)
          .attr("height", function (d) { return height - y2(d.count); })
          .attr("fill", colorPalette[0]);

        // Update existing bars
        bars.transition()
          .duration(750)
          .attr("x", function (d) { return x2(d.year) - barWidth / 2; })
          .attr("y", function (d) { return y2(d.count); })
          .attr("width", barWidth)
          .attr("height", function (d) { return height - y2(d.count); })
          .attr("fill", colorPalette[0]);

        // Remove old bars
        bars.exit().remove();

        // Update x axis
        svg2.select(".axis-x2")
          .transition()
          .duration(750)
          .call(d3.axisBottom(x2)
            .tickFormat(d3.format("d"))
            .tickValues(d3.range(1980, 2017)))
          .selectAll("text")
          .style("text-anchor", "end")
          .attr("dx", "-.8em")
          .attr("dy", ".15em")
          .attr("transform", "rotate(-45)");


        // Update y axis
        svg2.select(".axis-y2")
          .transition()
          .duration(750)
          .call(d3.axisLeft(y2)
          );

        // Add x axis label
        svg2.selectAll(".x-axis-label2").remove();
        svg2.append("text")
          .attr("class", "x-axis-label2")
          .attr("x", width / 2)
          .attr("y", height + margin.bottom - 10)
          .style("text-anchor", "middle")
          .text("Year");

        // Add y axis label
        svg2.selectAll(".y-axis-label2").remove();
        svg2.append("text")
          .attr("class", "y-axis-label2")
          .attr("transform", "rotate(-90)")
          .attr("y", 0 - margin.left)
          .attr("x", 0 - (height / 2))
          .attr("dy", "1em")
          .style("text-anchor", "middle")
          .text("Number of Games");

        // Add title
        svg2.selectAll(".chart-title2").remove();
        svg2.append("text")
          .attr("class", "chart-title2")
          .attr("x", width / 2)
          .attr("y", 0 - (margin.top / 2))
          .attr("text-anchor", "middle")
          .style("font-size", "16px")
          .style("text-decoration", "underline")
          .text("Number of Games for " + selectedGenre + " by Year");
      }

      // Initial chart rendering
      updateChart1(d3.max(years));
      updateChart2('all');

      // Update charts when slider is changed
      yearSlider.on("input", function () {
        var selectedYear = d3.select(this).property("value");
        updateChart1(selectedYear);
      });

      // Update charts when genre is changed
      genreSelect.on("change", function () {
        var selectedGenre = d3.select(this).property("value");
        updateChart2(selectedGenre);
      });
    });
  </script>
</body>

</html>